import test from 'ava'

import Message, { MessageType, ReturnCode } from '../src'

test('normal query', (t) => {
  const request = new Message(43825)
  request.addQuestion('www.example.com')
  const encodedRequest = request.encode()
  t.deepEqual(Array.from(encodedRequest), [0xab, 0x31, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x77, 0x77, 0x77, 0x07, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01])

  const decodedRequest = Message.parse(encodedRequest.buffer as ArrayBuffer)
  t.deepEqual(decodedRequest, request)

  decodedRequest.type = MessageType.response
  decodedRequest.recursionAvailable = true
  decodedRequest.addAddress('www.example.com', 20680, '93.184.216.34')

  const encodedAnswer = decodedRequest.encode()
  t.deepEqual(Array.from(encodedAnswer), [0xab, 0x31, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x03, 0x77, 0x77, 0x77, 0x07, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x50, 0xc8, 0x00, 0x04, 0x5d, 0xb8, 0xd8, 0x22])

  const decodedAnswer = Message.parse(encodedAnswer.buffer as ArrayBuffer)
  t.deepEqual(decodedAnswer, decodedRequest)
})

test('name not found query', (t) => {
  const request = new Message(0x7203)
  request.addQuestion('www.example.comy')
  const encodedRequest = request.encode()
  t.deepEqual(Array.from(encodedRequest), [0x72, 0x03, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x77, 0x77, 0x77, 0x07, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x04, 0x63, 0x6f, 0x6d, 0x79, 0x00, 0x00, 0x01, 0x00, 0x01])

  const decodedRequest = Message.parse(encodedRequest.buffer as ArrayBuffer)
  t.deepEqual(decodedRequest, request)

  decodedRequest.type = MessageType.response
  decodedRequest.recursionAvailable = true
  decodedRequest.returnCode = ReturnCode.nameError

  const encodedAnswer = decodedRequest.encode()
  t.deepEqual(Array.from(encodedAnswer), [0x72, 0x03, 0x81, 0x83, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x77, 0x77, 0x77, 0x07, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x04, 0x63, 0x6f, 0x6d, 0x79, 0x00, 0x00, 0x01, 0x00, 0x01])

  const decodedAnswer = Message.parse(encodedAnswer.buffer as ArrayBuffer)
  t.deepEqual(decodedAnswer, decodedRequest)
})

test('CNAME answer', (t) => {
  const request = new Message(43825)
  request.addQuestion('www.baidu.com')
  const encodedRequest = request.encode()
  t.deepEqual(Array.from(encodedRequest), [0xab, 0x31, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x77, 0x77, 0x77, 0x05, 0x62, 0x61, 0x69, 0x64, 0x75, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01])

  const decodedRequest = Message.parse(encodedRequest.buffer as ArrayBuffer)
  t.deepEqual(decodedRequest, request)

  decodedRequest.type = MessageType.response
  decodedRequest.recursionAvailable = true
  const shifenAddress = 'www.a.shifen.com'
  decodedRequest.addCNAME('www.baidu.com', 429, shifenAddress)
  decodedRequest.addAddress(shifenAddress, 134, '115.239.211.112')
  decodedRequest.addAddress(shifenAddress, 134, '115.239.210.27')

  const encodedAnswer = decodedRequest.encode()
  t.deepEqual(Array.from(encodedAnswer), [0xab, 0x31, 0x81, 0x80, 0x00, 0x01, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x03, 0x77, 0x77, 0x77, 0x05, 0x62, 0x61, 0x69, 0x64, 0x75, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x05, 0x00, 0x01, 0x00, 0x00, 0x01, 0xad, 0x00, 0x0f, 0x03, 0x77, 0x77, 0x77, 0x01, 0x61, 0x06, 0x73, 0x68, 0x69, 0x66, 0x65, 0x6e, 0xc0, 0x16, 0xc0, 0x2b, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x86, 0x00, 0x04, 0x73, 0xef, 0xd3, 0x70, 0xc0, 0x2b, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x86, 0x00, 0x04, 0x73, 0xef, 0xd2, 0x1b])

  const decodedAnswer = Message.parse(encodedAnswer.buffer as ArrayBuffer)
  t.deepEqual(decodedAnswer, decodedRequest)
})
